#!/bin/bash
#
# pvefind: find vm's/containers on proxmox systems

CFG=~/.pve-find.ini
SW="jq curl"

usage() {
   echo "Usage: pve-find <options> [name]"
   echo "Searches all nodes/clusters defined in the config file for VM/CT names containing"
   echo "the given name."
   echo
   echo "  -i      Include inactive systems."
   echo "  -v      Be more verbose."
   echo "  -c      Connect to the console of the first system found."
   exit 1
}

parse_config() {

   while IFS='= ' read var val
   do
      if [[ $var == \[*] ]]
      then
          section=${var:1:-1}
      elif [[ $val ]]
      then
          declare -g -A "$var[$section]=$val"
      fi
   done < $CFG
}

find_name() {
   cluster=$1
   name=$2

   unset clause
   test $active -eq 1 && clause="and .status == \"running\""

   data=$(curl -s -k -d @<(cat <<<"username=${user[$cluster]}&password=${password[$cluster]}")  https://${hostname[$cluster]}:8006/api2/json/access/ticket)
   test "$data" = "${data/ticket/}" && { echo "Unable to login to PVE."; exit 1; }

   cookie=$(echo $data | jq --raw-output '.data.ticket' | sed 's/^/PVEAuthCookie=/')
   token=$(echo $data | jq --raw-output '.data.CSRFPreventionToken')
   CURL="curl -f -s -S -k -b $cookie"

   nodes="$($CURL -H "CSRFPreventionToken: $token" https://${hostname[$cluster]}:8006/api2/json/nodes/ | jq -r ".data[] | .node")"
   for node in $nodes
   do
      data="$($CURL -H "CSRFPreventionToken: $token" https://${hostname[$cluster]}:8006/api2/json/nodes/$node/lxc/) $($CURL -H "CSRFPreventionToken: $token" https://${hostname[$cluster]}:8006/api2/json/nodes/$node/qemu/)"
      echo $data | jq -r ".data[] | select((.name  | contains(\"$name\")) $clause) | \"$node \(.vmid) \(.name) \(.type // \"qemu\") \(.status)\""
   done
}

sanity_check() {
   err=0

   ! test -f $CFG && { echo "No config file found ($CFG)."; err=1; }

   test $err -eq 0 && test $(stat -c %a $CFG) -gt 600 && { echo "Unsafe permissions on config file."; err=1; }

   for name in $SW
   do
      if ! which $name > /dev/null 2>&1
      then
         missing="$missing $name"
         err=1
      fi
   done
   test "$missing" != "" && echo "Missing required software to run script:$missing"

   test $# -lt 1 && { echo "At least one argument required."; err=1; }

   test $err -ne 0 && usage
}

parse_options() {
   while getopts :icv opt
   do
      case $opt in
         v) verbose=1
         ;;
         c) connect=1
         ;;
         i) active=0
         ;;
         \?) echo "Unknowing options: -$OPTARG"
             usage
         ;;
      esac
   done
   shift $((OPTIND -1))
   name=$1
}

main() {
   unset https_proxy
   active=1
   connect=0
   verbose=0

   sanity_check "$@"

   parse_config

   parse_options "$@"

   output=$(tempfile)

   for cluster in ${!hostname[*]}
   do
      find_name $cluster $name >> $output &
   done
   wait
   if test $connect = 1; then
      read server vmid name type status < <(head -1 $output)
      case $type in
      "qemu")
         test $verbose -eq 1 && echo "Connecting to server $server for $name..."
         ssh -t $server qm terminal $vmid
         ;;
      "lxc")
         test $verbose -eq 1 && echo "Connecting to server $server for $name..."
         ssh -t $server pct enter $vmid
         ;;
      esac
   else
      cat $output
   fi
   rm -f $output
}

main "$@"
